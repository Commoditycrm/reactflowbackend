name: Ensure Server Cron Jobs

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 0 * * 0" # Sun 00:00 UTC (optional)

jobs:
  ensure-cron:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure cron entries on Lightsail
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.LIGHTSAIL_HOST }}
          username: ${{ secrets.LIGHTSAIL_USER }}
          key: ${{ secrets.LIGHTSAIL_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euo pipefail

            APP_DIR="/var/www/app"
            JOBS_DIR="$APP_DIR/jobs"
            LOGS_DIR="$APP_DIR/logs"

            SCRIPTS="create-recurring-task.sh reset-whatsapp-counter.sh send-reminders.sh warmup.sh soft-delete-data-clean-up.sh"
            SCHEDULE="30 3 * * *"

            # Ensure logs dir; start cron if needed
            mkdir -p "$LOGS_DIR"
            sudo systemctl is-active --quiet cron || sudo systemctl start cron

            # Mark present scripts executable
            for f in $SCRIPTS; do
              [ -f "$JOBS_DIR/$f" ] && chmod +x "$JOBS_DIR/$f" || echo "WARN: missing $JOBS_DIR/$f"
            done

            # helper to add/ensure a line (idempotent)
            ensure_line () {
              line="$1"
              ( crontab -l 2>/dev/null | grep -Fv -- "$line" || true; echo "$line" ) | crontab -
            }

            ensure_line "$SCHEDULE $JOBS_DIR/create-recurring-task.sh >> $LOGS_DIR/create-recurring-task.log 2>&1"
            ensure_line "$SCHEDULE $JOBS_DIR/reset-whatsapp-counter.sh >> $LOGS_DIR/reset-whatsapp-counter.log 2>&1"
            ensure_line "$SCHEDULE $JOBS_DIR/send-reminders.sh >> $LOGS_DIR/send-reminders.log 2>&1"
            ensure_line "$SCHEDULE $JOBS_DIR/warmup.sh >> $LOGS_DIR/warmup.log 2>&1"
            ensure_line "$SCHEDULE $JOBS_DIR/soft-delete-data-clean-up.sh >> $LOGS_DIR/soft-delete-data-clean-up.log 2>&1"

            echo "---- FINAL USER CRONTAB ----"
            crontab -l || true
            echo "----------------------------"
